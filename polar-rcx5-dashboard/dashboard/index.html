<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Entrenamientos - Polar RCX5 (HR y Duraci贸n)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .chart-container h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .sessions-list {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .session-item {
            border-bottom: 1px solid #eee;
            padding: 15px;
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 2fr;
            gap: 10px;
            align-items: center;
        }
        
        .session-item:last-child {
            border-bottom: none;
        }
        
        .session-item:hover {
            background: #f5f5f5;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .badge-success {
            background: #4caf50;
            color: white;
        }
        
        .badge-warning {
            background: #ff9800;
            color: white;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            padding: 50px;
        }
        
        #session-selector {
            transition: all 0.3s ease;
        }
        
        #session-selector:hover {
            border-color: #764ba2;
        }
        
        #session-selector:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1> Dashboard de Entrenamientos</h1>
        <p style="text-align: center; color: white; margin-top: -20px; margin-bottom: 20px; opacity: 0.9;">
            Frecuencia Card铆aca y Duraci贸n
        </p>
        
        <div id="loading" class="loading">Cargando datos...</div>
        
        <div id="file-input-container" style="display: none;"></div>
        
        <div id="dashboard" style="display: none;">
            <div class="stats-grid" id="stats-grid"></div>
            
            <div class="chart-container">
                <h2> Entrenamientos por Mes</h2>
                <canvas id="chart-monthly"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>わ Frecuencia Card铆aca Promedio</h2>
                <canvas id="chart-hr"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>憋 Duraci贸n Total por Mes</h2>
                <canvas id="chart-duration"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>わ Evoluci贸n de Frecuencia Card铆aca por Sesi贸n</h2>
                <div style="margin-bottom: 20px;">
                    <label for="session-selector" style="display: block; margin-bottom: 10px; color: #667eea; font-weight: bold;">
                        Selecciona una sesi贸n:
                    </label>
                    <select id="session-selector" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #667eea; font-size: 1em; background: white; cursor: pointer;">
                        <option value="">-- Selecciona una sesi贸n --</option>
                    </select>
                </div>
                <div id="hr-evolution-info" style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
                    <strong id="selected-session-name"></strong><br>
                    <small id="selected-session-details"></small>
                </div>
                <canvas id="chart-hr-evolution"></canvas>
                <div id="no-hr-samples" style="text-align: center; padding: 40px; color: #999; display: none;">
                    Esta sesi贸n no tiene muestras de frecuencia card铆aca disponibles.
                </div>
            </div>
            
            <div class="sessions-list">
                <h2 style="margin-bottom: 20px; color: #667eea;"> Lista de Entrenamientos</h2>
                <div id="sessions-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Funci贸n para cargar archivo JSON
        function loadJSONFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('file-input-container').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    renderDashboard(data);
                } catch (error) {
                    alert('Error al parsear el archivo JSON: ' + error.message);
                    console.error('Error:', error);
                }
            };
            reader.readAsText(file);
        }
        
        // Intentar cargar autom谩ticamente si est谩 disponible
        fetch('entrenamientos_dashboard/entrenamientos.json')
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Archivo no encontrado');
            })
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('file-input-container').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                renderDashboard(data);
            })
            .catch(error => {
                // Si falla la carga autom谩tica, mostrar selector de archivo
                document.getElementById('loading').innerHTML = 
                    '<div style="text-align: center;"><p style="margin-bottom: 20px;"> Selecciona el archivo JSON de entrenamientos:</p>' +
                    '<input type="file" id="json-file-input" accept=".json" style="font-size: 1.1em; padding: 10px; border-radius: 5px; cursor: pointer;">' +
                    '<p style="margin-top: 20px; font-size: 0.9em; opacity: 0.8;">Ruta esperada: entrenamientos_dashboard\\entrenamientos.json</p></div>';
                
                const fileInput = document.getElementById('json-file-input');
                if (fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        if (e.target.files.length > 0) {
                            loadJSONFile(e.target.files[0]);
                        }
                    });
                }
                console.error('Error:', error);
            });

        function renderDashboard(data) {
            const sessions = data.sessions;
            
            // Calcular estad铆sticas - SOLO HR y duraci贸n
            const totalSessions = sessions.length;
            const totalDuration = sessions.reduce((sum, s) => sum + (s.duration_seconds || 0), 0);
            
            // Estad铆sticas de HR
            const sessionsWithHR = sessions.filter(s => s.hr_avg !== null && s.hr_avg !== undefined);
            const avgHR = sessionsWithHR.length > 0
                ? sessionsWithHR.reduce((sum, s) => sum + (s.hr_avg || 0), 0) / sessionsWithHR.length
                : 0;
            const maxHR = sessionsWithHR.length > 0
                ? Math.max(...sessionsWithHR.map(s => s.hr_max || 0))
                : 0;
            const minHR = sessionsWithHR.length > 0
                ? Math.min(...sessionsWithHR.map(s => s.hr_min || 0).filter(h => h > 0))
                : 0;
            
            // Renderizar tarjetas de estad铆sticas
            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-card">
                    <h3>Total Entrenamientos</h3>
                    <div class="value">${totalSessions}</div>
                </div>
                <div class="stat-card">
                    <h3>Tiempo Total</h3>
                    <div class="value">${formatDuration(totalDuration)}</div>
                </div>
                <div class="stat-card">
                    <h3>HR Promedio</h3>
                    <div class="value">${Math.round(avgHR)} bpm</div>
                </div>
                <div class="stat-card">
                    <h3>HR M谩ximo</h3>
                    <div class="value">${maxHR} bpm</div>
                </div>
                <div class="stat-card">
                    <h3>HR M铆nimo</h3>
                    <div class="value">${minHR} bpm</div>
                </div>
            `;
            
            // Gr谩fico de entrenamientos por mes
            const monthlyData = groupByMonth(sessions);
            new Chart(document.getElementById('chart-monthly'), {
                type: 'bar',
                data: {
                    labels: Object.keys(monthlyData),
                    datasets: [{
                        label: 'Entrenamientos',
                        data: Object.values(monthlyData),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            // Gr谩fico de HR promedio
            const hrData = sessions
                .filter(s => s.hr_avg !== null && s.hr_avg !== undefined)
                .sort((a, b) => new Date(a.start_time) - new Date(b.start_time))
                .slice(-20) // ltimos 20 entrenamientos
                .map(s => ({
                    x: new Date(s.start_time).toLocaleDateString('es-ES'),
                    y: s.hr_avg
                }));
            
            new Chart(document.getElementById('chart-hr'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'HR Promedio (bpm)',
                        data: hrData,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // Gr谩fico de duraci贸n por mes
            const durationByMonth = groupDurationByMonth(sessions);
            new Chart(document.getElementById('chart-duration'), {
                type: 'line',
                data: {
                    labels: Object.keys(durationByMonth),
                    datasets: [{
                        label: 'Duraci贸n (horas)',
                        data: Object.values(durationByMonth).map(d => d / 3600),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Configurar selector de sesiones para gr谩fico de evoluci贸n HR
            setupHREvolutionChart(sessions);
            
            // Lista de sesiones - SOLO HR y duraci贸n
            const sessionsHTML = sessions
                .sort((a, b) => new Date(b.start_time) - new Date(a.start_time))
                .map(s => {
                    const hrInfo = s.hr_avg 
                        ? `Prom: ${s.hr_avg} | Max: ${s.hr_max || '-'} | Min: ${s.hr_min || '-'}`
                        : 'Sin datos HR';
                    
                    return `
                    <div class="session-item">
                        <div>
                            <strong>${new Date(s.start_time).toLocaleDateString('es-ES')}</strong><br>
                            <small>${new Date(s.start_time).toLocaleTimeString('es-ES')}</small>
                        </div>
                        <div>
                            ${s.duration_formatted || formatDuration(s.duration_seconds || 0)}<br>
                            <small>Duraci贸n</small>
                        </div>
                        <div>
                            ${s.has_hr ? 'わ Con HR' : '锔 Sin HR'}
                        </div>
                        <div>
                            ${hrInfo}
                        </div>
                    </div>
                `;
                }).join('');
            
            document.getElementById('sessions-list').innerHTML = sessionsHTML;
        }
        
        function groupByMonth(sessions) {
            const grouped = {};
            sessions.forEach(s => {
                const date = new Date(s.start_time);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                grouped[key] = (grouped[key] || 0) + 1;
            });
            return grouped;
        }
        
        function groupDurationByMonth(sessions) {
            const grouped = {};
            sessions
                .filter(s => s.duration_seconds)
                .forEach(s => {
                    const date = new Date(s.start_time);
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    grouped[key] = (grouped[key] || 0) + (s.duration_seconds || 0);
                });
            return grouped;
        }
        
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours}h ${minutes}m ${secs}s`;
        }
        
        let hrEvolutionChart = null;
        
        function setupHREvolutionChart(sessions) {
            const selector = document.getElementById('session-selector');
            const infoDiv = document.getElementById('hr-evolution-info');
            const noSamplesDiv = document.getElementById('no-hr-samples');
            const canvas = document.getElementById('chart-hr-evolution');
            
            // Llenar selector con sesiones que tienen HR
            const sessionsWithHR = sessions
                .filter(s => s.has_hr && s.hr_samples && s.hr_samples.length > 0)
                .sort((a, b) => new Date(b.start_time) - new Date(a.start_time));
            
            sessionsWithHR.forEach((session, index) => {
                const option = document.createElement('option');
                option.value = index;
                const date = new Date(session.start_time);
                option.textContent = `${date.toLocaleDateString('es-ES')} ${date.toLocaleTimeString('es-ES')} - ${session.duration_formatted}`;
                selector.appendChild(option);
            });
            
            // Guardar sesiones en el selector para acceso r谩pido
            selector.sessionsData = sessionsWithHR;
            
            // Event listener para cambio de selecci贸n
            selector.addEventListener('change', function() {
                const selectedIndex = this.value;
                
                if (selectedIndex === '' || selectedIndex === null) {
                    // Ocultar gr谩fico si no hay selecci贸n
                    if (hrEvolutionChart) {
                        hrEvolutionChart.destroy();
                        hrEvolutionChart = null;
                    }
                    infoDiv.style.display = 'none';
                    noSamplesDiv.style.display = 'none';
                    canvas.style.display = 'none';
                    return;
                }
                
                const selectedSession = sessionsWithHR[parseInt(selectedIndex)];
                
                if (!selectedSession || !selectedSession.hr_samples || selectedSession.hr_samples.length === 0) {
                    // No hay muestras de HR
                    if (hrEvolutionChart) {
                        hrEvolutionChart.destroy();
                        hrEvolutionChart = null;
                    }
                    infoDiv.style.display = 'none';
                    canvas.style.display = 'none';
                    noSamplesDiv.style.display = 'block';
                    return;
                }
                
                // Mostrar informaci贸n de la sesi贸n
                const date = new Date(selectedSession.start_time);
                document.getElementById('selected-session-name').textContent = 
                    `Sesi贸n del ${date.toLocaleDateString('es-ES')} ${date.toLocaleTimeString('es-ES')}`;
                
                const details = [
                    `Duraci贸n: ${selectedSession.duration_formatted}`,
                    selectedSession.hr_avg ? `HR Promedio: ${selectedSession.hr_avg} bpm` : '',
                    selectedSession.hr_max ? `HR M谩ximo: ${selectedSession.hr_max} bpm` : '',
                    selectedSession.hr_min ? `HR M铆nimo: ${selectedSession.hr_min} bpm` : '',
                    `Muestras: ${selectedSession.hr_samples.length}`
                ].filter(d => d).join(' | ');
                
                document.getElementById('selected-session-details').textContent = details;
                infoDiv.style.display = 'block';
                noSamplesDiv.style.display = 'none';
                canvas.style.display = 'block';
                
                // Crear o actualizar gr谩fico
                if (hrEvolutionChart) {
                    hrEvolutionChart.destroy();
                }
                
                // Rango fisiol贸gico v谩lido (bpm). Valores fuera son errores de parsing.
                const HR_MIN = 30;
                const HR_MAX = 250;
                
                // Filtrar muestras con HR en rango v谩lido
                const validSamples = selectedSession.hr_samples.filter(s => 
                    s.hr != null && s.hr >= HR_MIN && s.hr <= HR_MAX
                );
                
                // Preparar datos para el gr谩fico (solo valores v谩lidos)
                const hrData = validSamples.map(sample => ({
                    x: sample.time_seconds / 60,
                    y: sample.hr
                }));
                
                // Calcular estad铆sticas solo con valores v谩lidos
                const hrValues = validSamples.map(s => s.hr);
                const minHR = hrValues.length > 0 ? Math.min(...hrValues) : 60;
                const maxHR = hrValues.length > 0 ? Math.max(...hrValues) : 180;
                const avgHR = hrValues.length > 0 ? hrValues.reduce((a, b) => a + b, 0) / hrValues.length : 0;
                
                if (hrData.length === 0) {
                    if (hrEvolutionChart) {
                        hrEvolutionChart.destroy();
                        hrEvolutionChart = null;
                    }
                    infoDiv.style.display = 'block';
                    document.getElementById('selected-session-details').textContent = 
                        'No hay muestras de HR en rango v谩lido (30-250 bpm). Los datos pueden estar corruptos.';
                    noSamplesDiv.style.display = 'block';
                    canvas.style.display = 'none';
                    return;
                }
                
                hrEvolutionChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Frecuencia Card铆aca (bpm)',
                            data: hrData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        }, {
                            label: 'HR Promedio',
                            data: hrData.map(d => ({ x: d.x, y: avgHR })),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            return `HR: ${context.parsed.y} bpm`;
                                        } else {
                                            return `Promedio: ${context.parsed.y.toFixed(1)} bpm`;
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Tiempo (minutos)'
                                },
                                min: 0,
                                max: Math.max(10, Math.ceil((hrData.length > 0 ? Math.max(...hrData.map(d => d.x)) : 0) / 5) * 5),
                                ticks: {
                                    stepSize: 5
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Frecuencia Card铆aca (bpm)'
                                },
                                min: 40,
                                max: 220,
                                beginAtZero: false
                            }
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>
